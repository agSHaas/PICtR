---
title: "PICtR: Physically Interacting Cell toolkit for R"
author: "Viktoria Flore"
date: "09/2024"
output: 
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 2
    number_sections: true
    highlight: tango
vignette: >
  %\VignetteIndexEntry{PICtR: Physically Interacting Cell toolkit for R}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>", 
  warning = FALSE
)
```

# Introduction

Many fundamental processes in life are shaped by physical interactions between cells. PICtR provides a computational workflow to analyse both cellular landscapes and cellular interactions in high-dimensional flow cytometry data using R. PICtR can be used with any cytometry-based assay and the approach can also be applied to existing datasets, provided that the following guidelines are met:  

- The data stems from a case-control setting
- All samples were treated the same during sample processing and acquisition, e.g. regarding equal cell concentrations, incubation times, and flow rates 
- Samples should not be pooled across conditions, organs or donors
- For *in vivo* experiments, cells with a strong affinity to interact can artificially interact if they are brought into proximity during sample preparation, even if they were physically separated *in vivo*. These interactions may still be biologically meaningful, but take this into account when interpreting the results.  


# Installation

PICtR requires R version 4.3 or later. Before installing PICtR, please ensure that [BPCells](https://github.com/bnprks/BPCells) is installed: 

```{r, eval=FALSE}
if (!require("BPCells", quietly = TRUE)) {
  if (!require("remotes", quietly = TRUE)) {
    install.packages("remotes")
  }
  remotes::install_github("bnprks/BPCells/r")
}
```

To install PICtR please download the source package and use: 
```{r, eval=FALSE}
remotes::install_local("path_to_file", dependencies = T)
```

Or, upon publication, install PICtR from GitHub:
```{r, eval=FALSE}
if (!require("remotes", quietly = TRUE)) {
  install.packages("remotes")
}

remotes::install_github("agSHaas/PICtR")
```


Some other packages are not necessarily required, but expand the functionality of PICtR. Consider installing  

- [flowMeans](https://www.bioconductor.org/packages/release/bioc/html/flowMeans.html)  
- [dbscan](https://github.com/mhahsler/dbscan)  
- [Spectre](https://github.com/ImmuneDynamics/Spectre)
- [ComplexHeatmap](https://www.bioconductor.org/packages/release/bioc/html/ComplexHeatmap.html)  
- [cytoMEM](https://www.bioconductor.org/packages/release/bioc/html/cytoMEM.html)  


# PICtR Pipeline

## Pre-Processing of Cytometry Data 

Data from FCS files should be unmixed/compensated and transformed (for example using FlowJo from BD). We recommend using quality control tools such as [PeacoQC](https://doi.org/10.1002/cyto.a.24501) or [FlowAI](https://doi.org/10.1093/bioinformatics/btw191) to ensure high quality cytometry data. Export the populations of interest using channel values defined by the inbuilt export function of FlowJo or use [flowWorkspace](https://github.com/RGLab/flowWorkspace).

## Example Data

We provide a small demo data set from the spleen of one lymphocytic choriomeningitis virus (LCMV) infected mouse. Five days prior to infection, LCMV-specific T cells were transferred into the host, so that we can differentiate between antigen-specific interactions between immune cells and bystander interactions. The samples were analysed using high parametric spectral flow cytometry with n=26 markers, allowing us to detect all important cell types across the immune cell landscape. You can read more about the experiment in the manuscript accompanying the PICtR package. 

Demo data can be loaded with `data(demo_lcmv)`. See `?demo_lcmv` for details.  


## Subsampling, Dimensional Reduction and Clustering 

The pipeline starts with a data frame with the dimensionality cells x flow cytometry parameters. First, we calculate the FSC ratio based on the forward scatter area (FSC-A) and forward scatter height (FSC-H) parameters. The FSC ratio is highly discriminatory for singlets and multiplets, and will help us to select interacting populations later on. We find a threshold that classifies all events as having a low or high FSC ratio using thresholding methods such as Otsu thresholding.
  
Then, we create a Seurat object using forward scatter parameters, side scatter parameters, cell type markers and the FSC ratio as features. We store the counts layer on-disk using [BPCells](https://github.com/bnprks/BPCells), enabling us to analyse millions of events while keeping computational time manageable. Thus far, we have analysed up to 60 million events with PICtR. 
In addition, we sample a representative subset of cells using atomic sketching as implemented in [Seurat](https://satijalab.org/seurat/articles/parsebio_sketch_integration). In contrast to random sampling, sketching retains both abundant and rare cell types, including cellular interactions. For the demo data set, we sample `n_sketch_cells = 5000` cells. We use the sketched data set for dimensional reduction and clustering, before predicting cell type and interaction labels back to the full data set later on.  

PICtR provides a convenient wrapper function for these steps: 
```{r wrapper}
library(PICtR, quietly = T)
data(demo_lcmv)

demo_obj <- sketch_wrapper(demo_lcmv,
                       meta_data = demo_lcmv,
                       assay = "FACS",
                       FSC.A = "FSC.A", 
                       FSC.H = "FSC.H", 
                       working_dir = getwd(),
                       resolution = c(0.5, 1),
                       clst_algorithm = 1,
                       n_sketch_cells = 5000,
                       obj_name = "obj_sketched_non_projected",
                       ratio = T, 
                       thresholding_method = "otsu", 
                       overwrite = T)
```

### Guidelines for Clustering 

Finding a good clustering resolution is critical to detecting interacting populations. PICtR provides several different options for clustering. In addition to [Louvain](10.1088/1742-5468/2008/10/P10008), [SLM](https://doi.org/10.1140/epjb/e2013-40829-0), and [Leiden](https://doi.org/10.1038/s41598-019-41695-z) algorithms, which are implemented in the Seurat framework, [FlowSOM](https://doi.org/10.1002/cyto.a.22625), [flowMeans](https://doi.org/10.1002/cyto.a.21007) and [HDBSCAN]( https://doi.org/10.1007/978-3-642-37456-2_14) (Hierarchical Density-Based Spatial Clustering of Applications with Noise) are available. We recommend using Louvain or Leiden due to their successful identification of interaction populations, fast run times, and easily customizable resolution parameter. Note that Leiden requires the leidenalg python package.    

The effect of the resolution parameter can be seen when comparing a resolution of 0.5 and 1 for the demo data set:
```{r clustering_resolution, fig.show='hold'}
DimPlot(demo_obj, group.by = "sketch_snn_res.0.5") + theme(legend.key.size = unit(3, 'pt'))
DimPlot(demo_obj, group.by = "sketch_snn_res.1") + theme(legend.key.size = unit(3, 'pt'))
```

We recommend to over-cluster the data to 

```{r feature_plots, include=FALSE}
features <- c("CD3", "CD4", "CD8", "CD19", "CD90.1", "CD45.1", "CD11b", "ratio")
plots = vector('list', length(features))
for(i in seq_along(features)){
  plots[[i]] = FeaturePlot(demo_obj, features = features[i]) + labs(title = features[i]) & scale_color_viridis_c()
}
```

```{r, echo=F, fig.show='hold'}
for (p in plots) {print(p)}
```


  
The [Seurat tutorials](https://satijalab.org/seurat/) and [Heumos, Schaar, Lance et al. (2023)](https://doi.org/10.1038/s41576-023-00586-w) provide excellent guidance on clustering of single-cell data sets. 

## Selecting Interacting Populations 

```{r, eval = F}
ratio_cluster_plot(demo_obj, clusters = "clusters_predicted_obj")

demo_obj <- select_dbt(demo_obj, clusters = "clusters_predicted_obj", quantile = 0.85)
```

## Annotation 

## Predict Labels for the full Data Set

```{r, eval = F}
demo_obj <- predict_data(obj = demo_obj, 
                      data_query = demo_obj, 
                      ref_clusters = "sketch_snn_res.0.8",
                      pred_name = "clusters_predicted_obj",
                      assay_ref = "sketch", 
                      assay_query = "FACS")
```

# Citing PICtR 

If you are using PICtR in your research, please consider citing:  

- Vonficht D, Jopp-Saile L, Yousefian S, Flore V et al. "Ultra-high scale cytometry-based cellular interaction mapping.", unpublished.

# References  
  
- Hao, Y., Stuart, T., Kowalski, M.H. et al. Dictionary learning for integrative, multimodal and scalable single-cell analysis. Nat Biotechnol 42, 293â€“304 (2024). <https://doi.org/10.1038/s41587-023-01767-y>  
- Heumos, L., Schaar, A.C., Lance, C. et al. Best practices for single-cell analysis across modalities. Nat Rev Genet (2023). <https://doi.org/10.1038/s41576-023-00586-w>  
- Parks B (2024). BPCells: Single Cell Counts Matrices to PCA. R package version 0.2.0, https://github.com/bnprks/BPCells, <https://bnprks.github.io/BPCells> 

```{r}
dbt=c("B*cDC1"="#573B88",
                   "B*cDC2"="#744598",
                   "B*Granulo"="#9151A4",
                   "B*Macro" ="#AD5FAD",
                   "B*Mono" ="#C36FB1",
                   "B*pDC"= "#E597B9",
                   "B_IgD+*Granulo"="#F4C5CB",
                   "B_IgD+*B"="#DDBFEE",
                   "B_IgD+*NK" = "#C19FE0" ,
                   "B*Prog" = "plum4",
                   "Plasmablast*Granulo" = "#C42B79", 
                   "Plasmablast*Macro"= "#A42276",
                  
                   "CD4_Ag_spec*B"= "#004529",
                   "CD4_Ag_spec*CD4_Ag_spec/CD4"="#006837",
                   "CD4_Ag_spec*CD8_Ag_spec" = "#238443" ,
                   "CD4_Ag_spec*CD8_Ag_spec*B"= "#41AB5D",
                   "CD4_Ag_spec*DC"="#78C679",
                   "CD4_Ag_spec*Granulo"="#ADDD8E",        
                   "CD4_Ag_spec*NK"="#D9F0A3",
                   "CD4_Ag_spec*Plasmablast" ="#F7FCB9",
                   "CD4_Ag_spec*CD24_hi" ="#CCCC8F",
                   
                   "CD4_pDC" ="#D7F9D0",                    
                   "CD4*B" ="#BCE6B1",
                   "CD4*B*Macro" ="#A0D494",
                   "CD4*CD8"  ="#3BA455",
                   "CD4*CD8*Myeloid"="#31BD67",
                   "CD4*CD8*TCRgd"  ="#0D804A",
                   "CD4*Plasmablast"="#18482F",
                   
                   "CD8_Ag_spec*B" ="#1D536A",
                   "CD8_Ag_spec*CD24_hi"="#2A6779",
                   "CD8_Ag_spec*CD4"="#3A7C89",
                   "CD8_Ag_spec*CD8"="#4B9197",
                   "CD8_Ag_spec*Granulo"="#61A6A4",
                   "CD8_Ag_spec*Myeloid" ="#7BBCB0",
                   "CD8_Ag_spec*CD4*Myeloid"= "#97D0BB",
                   "CD8_Ag_spec*NK"= "#B4E5C8",
                   "CD8_Ag_spec*Plasmablast"=  "#D2FBD4",
                   "CD8*B"="#81BADA" ,  
                   "CD8*CD4*B"="#084D96", 
                   "CD8*Plasmablast"="#3787C0",
                   "TCRgd*B"="#08306B",
                  
                   "NK*B*CD4" = "#FBE6C5",
                   
                   "NK*B*Macro" ="#F3B093",
                   "NK*B*Myeloid" ="#EF9386",
                   "NK*Myeloid" = "#BF5268",
                   "NK*CD4" = "#DC7176",
                   "NK*My_Prog"= "#D06170",
                   "B*NK"="#A4435F",
                   
                   "B_IgD+*pDC"="#8A3555",
                   "NK*Plasmablast"= "#70284A",
                   "Granulo*CD4"  =  "#FAB782",
                   "Granulo*CD8"  =  "#FCDE9C"
                    )
```

